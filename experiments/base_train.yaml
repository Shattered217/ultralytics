# ============================================================================
# 基础训练配置 (Base Training Configuration)
# ============================================================================
# 所有消融实验必须使用此配置文件作为基准，确保实验的公平性和可复现性
# 
# 使用方法:
#   1. 直接使用: python train.py --cfg experiments/base_train.yaml
#   2. 覆盖参数: python train.py --cfg experiments/base_train.yaml --epochs 200
#   3. 加载配置: from scripts.load_config import load_config
#
# 注意: 
#   - 所有超参数已明确指定，不依赖隐式默认值
#   - 消融实验只改变模型结构，不改变训练配置
#   - 如需调整参数，必须在所有实验中同步更改
# ============================================================================

# ----------------------------------------------------------------------------
# 数据集配置 (Dataset Configuration)
# ----------------------------------------------------------------------------
# 支持两个数据集：openparts (2100张，含test) 和 selfparts (499张，无test)
# 训练时指定其中一个数据集

# 默认使用 openparts 数据集（可通过命令行 --data 覆盖）
data: datasets/openparts/data.yaml

# 备选数据集：
# data: datasets/selfparts/data.yaml

# ----------------------------------------------------------------------------
# 模型配置 (Model Configuration)
# ----------------------------------------------------------------------------
# 模型架构在消融实验中会变化（baseline, +Ghost, +ECA, +P2等）
# 训练脚本中通过 --model 参数指定具体模型配置文件
# 例如: --model ultralytics/cfg/models/v8/yolov8n.yaml

# ----------------------------------------------------------------------------
# 训练基础参数 (Training Basic Parameters)
# ----------------------------------------------------------------------------
task: detect                # 任务类型：目标检测
mode: train                 # 模式：训练

# 图像尺寸（训练和验证使用相同尺寸，确保一致性）
imgsz: 640                  # 输入图像尺寸 (像素)

# 训练轮数（默认值，可通过命令行覆盖）
epochs: 100                 # 训练轮数（消融实验建议100-300）

# 批次大小（固定值策略，确保公平对比）
batch: 8                    # 固定批次大小（推荐：RTX 3090 24GB 可用 16-32）
                            # 注意：较大模型可能需要减小 batch size

# 如需自动批次大小（根据GPU显存自动调整），取消下面注释：
# batch: -1                 # 自动批次大小（不推荐用于消融实验）

# ----------------------------------------------------------------------------
# 优化器配置 (Optimizer Configuration)
# ----------------------------------------------------------------------------
optimizer: SGD              # 优化器：SGD (momentum) 或 Adam / AdamW
                            # SGD 更稳定，Adam 收敛更快但可能过拟合

# 学习率策略
lr0: 0.01                   # 初始学习率（SGD推荐 0.01，Adam推荐 0.001）
lrf: 0.01                   # 最终学习率 = lr0 * lrf（余弦退火）

# 优化器超参数
momentum: 0.937             # SGD 动量（推荐 0.937）
weight_decay: 0.0005        # 权重衰减 L2 正则化（推荐 0.0005）

# 学习率调度器
warmup_epochs: 3.0          # 预热轮数（推荐 3-5）
warmup_momentum: 0.8        # 预热期动量（推荐 0.8）
warmup_bias_lr: 0.1         # 预热期偏置学习率（推荐 0.1）

# ----------------------------------------------------------------------------
# 损失函数权重 (Loss Weights)
# ----------------------------------------------------------------------------
# YOLO 损失包含三部分：box（定位）、cls（分类）、dfl（分布焦点损失）
box: 7.5                    # 边界框损失权重（推荐 7.5）
cls: 0.5                    # 分类损失权重（推荐 0.5）
dfl: 1.5                    # DFL 损失权重（推荐 1.5，YOLOv8 特有）

# ----------------------------------------------------------------------------
# 数据增强 (Data Augmentation)
# ----------------------------------------------------------------------------
# 注意：增强策略对小目标检测很重要，但过强会影响收敛

# Mosaic 增强（将4张图拼接为1张）
mosaic: 1.0                 # Mosaic 概率（1.0 = 始终使用，0.0 = 不使用）
close_mosaic: 10            # 最后 N 个 epoch 关闭 Mosaic（推荐 10）

# MixUp 增强（混合两张图）
mixup: 0.0                  # MixUp 概率（推荐 0.0-0.1，过高影响收敛）

# 几何变换
degrees: 0.0                # 旋转角度范围 (+/- deg，推荐 0-10）
translate: 0.1              # 平移范围（图像尺寸的比例，推荐 0.1）
scale: 0.5                  # 缩放范围（+/- gain，推荐 0.5）
shear: 0.0                  # 剪切角度范围 (+/- deg，推荐 0-5）
perspective: 0.0            # 透视变换范围（0.0-0.001，推荐 0.0）

# 翻转
flipud: 0.0                 # 上下翻转概率（推荐 0.0，除非数据集需要）
fliplr: 0.5                 # 左右翻转概率（推荐 0.5）

# 颜色增强（HSV 色彩空间）
hsv_h: 0.015                # 色调增强范围（0.0-1.0，推荐 0.015）
hsv_s: 0.7                  # 饱和度增强范围（0.0-1.0，推荐 0.7）
hsv_v: 0.4                  # 明度增强范围（0.0-1.0，推荐 0.4）

# 其他增强
copy_paste: 0.0             # Copy-Paste 增强概率（推荐 0.0，计算开销大）
auto_augment: randaugment   # 自动增强策略：randaugment, autoaugment, 或 None
erasing: 0.4                # 随机擦除概率（推荐 0.4）

# ----------------------------------------------------------------------------
# 硬件与性能配置 (Hardware & Performance)
# ----------------------------------------------------------------------------
device: 0                   # 设备：0 (GPU 0), 0,1 (多GPU), cpu
                            # 单GPU训练以确保一致性，多GPU需要同步BN

workers: 8                  # 数据加载线程数（推荐 4-8）
project: results/train      # 训练结果保存目录
name: exp                   # 实验名称（建议改为具体实验ID，如 E0_baseline）

# 分布式训练（单GPU实验保持关闭）
# 如果使用多GPU，需要额外配置：
# device: 0,1
# DDP: True

# ----------------------------------------------------------------------------
# 验证与保存策略 (Validation & Saving)
# ----------------------------------------------------------------------------
val: True                   # 是否在训练中验证
save: True                  # 是否保存检查点
save_period: -1             # 每 N 个 epoch 保存一次（-1 = 仅保存 last/best）
exist_ok: False             # 是否覆盖已存在的项目目录

# ----------------------------------------------------------------------------
# 其他训练配置 (Other Training Settings)
# ----------------------------------------------------------------------------
patience: 50                # 早停耐心值（N 个 epoch 无改进则停止，0 = 禁用）
pretrained: True            # 是否使用预训练权重（首次训练推荐 True）
resume: False               # 是否从检查点恢复训练

# 梯度相关
amp: True                   # 自动混合精度训练（AMP，推荐 True 以节省显存）
fraction: 1.0               # 使用数据集的比例（1.0 = 全部，可用于快速测试）

# 日志与可视化
verbose: True               # 是否打印详细日志
plots: True                 # 是否生成训练曲线和混淆矩阵图

# ----------------------------------------------------------------------------
# 固定随机种子配置 (Random Seed - 通过脚本设置)
# ----------------------------------------------------------------------------
# 注意：随机种子不在此处设置，而是在训练脚本开始时调用：
#   from scripts.set_determinism import set_seed
#   set_seed(args.seed)
# 
# 消融实验推荐使用 seeds=[0, 1, 2]，每个实验运行 3 次取平均值

# ============================================================================
# 实验配置说明 (Experiment Configuration Notes)
# ============================================================================
# 
# 1. 消融实验配置继承：
#    - 所有实验使用此 base_train.yaml 作为基础
#    - 仅改变模型配置文件（--model 参数）
#    - 不改变训练超参数
#
# 2. 参数覆盖示例：
#    python train.py \
#        --cfg experiments/base_train.yaml \
#        --data datasets/selfparts/data.yaml \
#        --epochs 200 \
#        --batch 16 \
#        --device 0 \
#        --name E1_ghost_seed0
#
# 3. 记录所有实验配置：
#    每次实验会自动保存完整配置到 results/train/<name>/args.yaml
#    用于后续审查和复现
#
# 4. 关键不变原则：
#    - optimizer, lr0, weight_decay 不变
#    - 数据增强策略不变
#    - 损失权重不变
#    - 只有模型结构在消融实验中变化
#
# ============================================================================
